# 腾讯面试题目

## 一面，电话面试

1. spring 怎么判断产生循环依赖
- 对于构造器循环依赖的情况，spring容器会正在创建的bean
- todo
2. innodb索引结构有哪些
- B+树
- Hash树
3. 非聚簇索引和聚簇索引
- 聚簇索引的非叶子节点存储的是关键字和指向子节点的指针，叶子节点存储的是具体的数据
- 非聚簇索引的非叶子节点存储的同样是关键字和指向子节点的指针，叶子节点存储的是主键id
4. b+  3层能存多少数据
- 2000万左右
- 默认页大小为16K，叶子节点按1K计算能放16个。非叶子节点有2层，每一层存储的都是主键id和指向子节点的指针，主键id8个字节，指针6个字节，这样计算的话，就是两千万左右
5. 区间查询怎么做的
- innnodb数据结构是B+树，它的叶子节点有指向下一个兄弟节点的指针，所以能通过指针进行范围查询。
6. 秒杀要注意哪些
- 安全
    - 秒杀连接不要泄露了
- 稳定、性能
    - 单独部署在高性能服务器上（防止影响其他系统）
    - 负载均衡，用多个实例
    - 对用户请求限流，对全局请求限流
    - 动静分离，可使用cdn，redis等
    - 缓存热点数据
    - 使用队列异步处理下单
    - 把对库存的读写放到redis里面来做
- 数据一致
    - 乐观锁，比如版本号实现
6. mq怎么保证不丢消息
- 平时工作中接触的比较多的是RocketMQ，我就讲讲Rocket吧
- 发送方丢失：
    - 发送方发送后会收到一个ACK，告知成功或失败，失败的时候可通过重试机制再次发送。如果仍然失败就需要自己添加补偿逻辑。
    - 不推荐使用事务消息，因为即使是事务消息也不保证成功。
- Broker丢失：持久化才能算消息投递成功，消息一开始会持久化到CommmitLog中，即使待机重启，也能恢复。同时它的同步刷盘、异步刷盘和同步复制、异步复制都可以保证消息存储在至少一个节点中
- 接收方丢失：接收方本地会维护一个持久化的 consumer offset，并且会实时上报给broker，即使失败了也会定期重试。即使Consumer挂了也没事儿，因为consume offset是持久化的。
7. 分布式事务  最终一致性具体实现细节
- 常见的方案有，2PC、TCC、本地消息表、事务消息+最终一致性、Sagas协同式和编排式。
- 最后要说的就是阿里的Seata了，功能强大，支持了XA、TCC、SAGA、AT 多种事务模式。
- 我们项目中使用的是 RocketMQ事务消息 + 最终一致性解决，要求不严格的业务也是用普通消息+最终一致性，毕竟事务消息性能差些。
8. seata问题
- AT 需要使用方只是本地ACID事务，原理是：业务数据和回滚日志在同一个本地事务中提交，失败则通过回滚日志进行回滚
- TCC 倒是不需要本地ACID事务支持，但是需要开发者对每一个事务都要提供prepare、commit、rollback逻辑，工作量有点大
- Saga 模式就比较复杂了，之前看微服务架构模式里面有讲这个东西，分了编排式和协同式，编排式更好。seata里面怎么实现的还没看过。
9. 分库分表会产生的问题分库
- Join问题
- 排序分页问题
- 我们的项目中只做了分库和垂直分表，没有做水平分表。
- 在我们的这种场景下，分库数据是会通过canal同步到ES中的，统计不成问题
9. canal是什么原理
- canal其实就是一个mysql的slave，
- 就是slave 连接到master后嘛，就会开启一个IO线程，去读取master的binlog到自己relaylog中，然后会有sql线程把relaylog的内容重新执行一遍
- 然后这儿的执行其实是同步的，所以说slave可能会延迟（防止出现并发安全）。想要解决的话可以开启半同步机制，它会要求至少一个slave返回了ack才算写成功。（还有一个是并行复制，是库级别的重放relaylog。）
10. 不能join怎么解决
- 可以用全局表（把这个要关联的表同步或复制到每一个要使用它的地方。）
- 然后ER分片（把有关联的数据放在一个分片中。）
- 再或者代码层解决。
11. 怎么做sql优化的  索引失效有哪些情况
sql优化：
- 这样吧，我用最近优化的一个接口来举例：
- 首先是主键索引：需要单调递增的Long型主键，使用redis按照snowflake算法生成。一方面，单调递增避免页分裂；另一方面，要求主键分布式唯一。
- 然后 覆盖索引：该接口会用到设备表的一些信息，为了避免join超过5张表，所以我是在业务逻辑层单独进行设备查询。那为了加快查询效率，就为设备表添加了覆盖索引。
- 然后 最左匹配原则：where条件多，所以使用联合索引，提高查询效率。
- 列区分度原则：将区分读最高的列放在联合索引的最左侧，所以把deviceId放在了最左侧，它在我们系统中是比商户/门店GUID 更容易区分的列。
- in关键字的索引匹配：将第一个 in 作为联合索引的最后一个列，将另一个 in 的列拆分为多个查询，并使用 union all 汇总结果行。这样子每一个查询都能走索引。
- 因条件缺省造成的索引匹配失效：在代码层做判断，调用不同的查询语句，避免因缺省值造成联合索引失效。
- 排序规则：这个sql有分页需求，但排序规则很复杂，无法在数据库实时完成。然后，考虑到这张表的读请求远大于写请求，因此在写请求时，更新排序字段的值，以便读请求时能在DB层面做分页，避免读取大量数据到内存中分页。
- 最后，肯定是要用explain分析一下：对于该接口的各种参数组合进行explain分析，确保都能走索引。
12. redis  事务原子性
- 都说是假原子性，因为后面失败后前面不会回滚。但是呢作者也说了，redis只会因为错误的语法而失败，是编程造成的，应该在开发阶段就被解决掉，不应该出现在生产环境。所以redis也不会支持回滚这个功能。
13. redis rdb细节，怎么保证数据不出错
- 有 SAVE 和 BGSAVE 两个指令可以让redis生成RDB文件
- SAVE的话是阻塞执行的，客户端发送的数据都会被拒绝，所以没有并发问题，数据不会出错
- BGSAVE的话是fork了子线程来执行的（fork的时候是阻塞主线程的），？？？？问宏洋，出错是丢失的意思？
14. Redlock什么情况下不可靠
15. 为什么多节点使用Redlock
16. 分布式锁
17. zookeeper怎么实现的  怎么保证节点顺序的


18. concurrentHash什么时候用到syc

19. mybatis源码
20. 怎么把数据转成对象的
21. 直接用jdbc怎么防止sql注入

22. 联合索引最左原则查询非聚簇索引过程

23. tcp  time wait问题

24. cms和g1的区别   g1在什么场景下使用
25. cms浮动垃圾怎么产生的


26. 操作系统怎么支持nio
27. netty
28. es倒排索引


29. 怎么保证服务高可用
30. 一致性哈希原理
31. 节点数少不均衡怎么办
32. 代码中怎么实现获取虚拟节点的数据范围


33. hystrix 线程隔离  信号量是怎么实现的   线程池隔离怎么实现的
34. ribbon请求策略有哪些
35. 怎么确定服务不可用  默认超时时间


36. 怎么分析内存溢出  什么命令导出dump   dump里面包含什么